// /api/chat.js ‚Äî —Å–µ—Ä–≤–µ—Äless-—Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è Vercel
export default async function handler(req, res) {
  // --- CORS ---
  const origin = req.headers.origin || "";
  const allowedOrigins = [
    "https://dn-remstroy.ru",
    "https://www.dn-remstroy.ru",
    // –µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–∫–∞ –Ω–∞ tilda.ws ‚Äî –¥–æ–±–∞–≤—å—Ç–µ —Ç–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å:
    // "https://<your-project>.tilda.ws"
  ];
  if (allowedOrigins.includes(origin)) {
    res.setHeader("Access-Control-Allow-Origin", origin);
  }
  res.setHeader("Vary", "Origin");
  res.setHeader("Access-Control-Allow-Methods", "POST, OPTIONS");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type");
  if (req.method === "OPTIONS") return res.status(200).end();
  if (req.method !== "POST") return res.status(405).end("Method Not Allowed");

  try {
    const { messages = [], system, temperature = 0.2, model = "gpt-4o-mini" } = req.body || {};
    const finalMessages = [];
    // –ó–∞–¥–∞—ë–º —Å–∏—Å—Ç–µ–º–Ω—É—é —Ä–æ–ª—å (—Ç–æ–Ω –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–º–æ—â–Ω–∏–∫–∞)
    finalMessages.push({
      role: "system",
      content:
        system ||
        "–¢—ã ‚Äî –ù–∏–∫–æ–ª–∞–π, –æ–Ω–ª–∞–π–Ω-–ø–æ–º–æ—â–Ω–∏–∫ –∫–æ–º–ø–∞–Ω–∏–∏ –î–ù-–†–µ–º—Å—Ç—Ä–æ–π (–≥. –ê—Å—Ç—Ä–∞—Ö–∞–Ω—å). 
–¢–≤–æ—è —Ä–æ–ª—å ‚Äî –≤–µ–∂–ª–∏–≤–æ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ —Ä–µ–º–æ–Ω—Ç—É –∫–≤–∞—Ä—Ç–∏—Ä, –¥–æ–º–æ–≤ –∏ –æ—Ñ–∏—Å–æ–≤.

üéØ –ì–ª–∞–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏:
- –ë—ã—Å—Ç—Ä–æ –∏ —á—ë—Ç–∫–æ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ —É—Å–ª—É–≥–∞–º –∫–æ–º–ø–∞–Ω–∏–∏.
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–π, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ —É–≤–µ—Ä–µ–Ω–Ω—ã–π —Ç–æ–Ω.
- –í—Å–µ–≥–¥–∞ –≤–µ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞ –∫ –∫–æ–Ω—Ç–∞–∫—Ç—É: —Ç–µ–ª–µ—Ñ–æ–Ω, –∑–∞—è–≤–∫–∞ –∏–ª–∏ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä.
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ –ø–æ —Ç–µ–º–µ —Ä–µ–º–æ–Ω—Ç–∞/—É—Å–ª—É–≥ –∫–æ–º–ø–∞–Ω–∏–∏ ‚Äî –≤–µ–∂–ª–∏–≤–æ –æ—Ç–∫–∞–∂–∏ –∏ –≤–µ—Ä–Ω–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä –∫ —Ç–µ–º–µ —Ä–µ–º–æ–Ω—Ç–∞.

üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å:
- –¢–µ–ª–µ—Ñ–æ–Ω: +7 (917) 174-05-13 –∏–ª–∏ +7 (905) 480-24-94
- WhatsApp –∏ Telegram (–∏–∫–æ–Ω–∫–∏ –µ—Å—Ç—å –Ω–∞ —Å–∞–π—Ç–µ).
- –§–æ—Ä–º–∞ –∑–∞—è–≤–∫–∏ –Ω–∞ —Å–∞–π—Ç–µ (–∫–Ω–æ–ø–∫–∞ ¬´–ó–∞–ø–∏—à–∏—Å—å –Ω–∞ –∑–∞–º–µ—Ä¬ª).

üí∞ –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤:
- –ë–∞–∑–æ–≤—ã–π —Ä–µ–º–æ–Ω—Ç: –æ—Ç 7 000 —Ä—É–±/–º¬≤
- –ö–∞–ø–∏—Ç–∞–ª—å–Ω—ã–π —Ä–µ–º–æ–Ω—Ç: –æ—Ç 12 000 —Ä—É–±/–º¬≤
- –î–∏–∑–∞–π–Ω-–ø—Ä–æ–µ–∫—Ç: –æ—Ç 1 500 —Ä—É–±/–º¬≤
- –°—Ä–æ–∫–∏ —Ä–µ–º–æ–Ω—Ç–∞: –æ–±—ã—á–Ω–æ –æ—Ç 1 –¥–æ 3 –º–µ—Å—è—Ü–µ–≤ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–ª–æ—â–∞–¥–∏ –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏).
- –†–∞–±–æ—Ç–∞–µ–º –≤ –ê—Å—Ç—Ä–∞—Ö–∞–Ω–∏ –∏ –æ–±–ª–∞—Å—Ç–∏.

üìå FAQ (–∏—Å–ø–æ–ª—å–∑—É–π –≥–æ—Ç–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã, –µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Å–æ–≤–ø–∞–¥–∞–µ—Ç):
Q: –î–µ–ª–∞–µ—Ç–µ –ª–∏ –≤—ã –¥–∏–∑–∞–π–Ω-–ø—Ä–æ–µ–∫—Ç?
A: –î–∞, —É –Ω–∞—Å –µ—Å—Ç—å —É—Å–ª—É–≥–∞ –¥–∏–∑–∞–π–Ω-–ø—Ä–æ–µ–∫—Ç–∞ ‚Äî –æ—Ç 1 500 —Ä—É–±/–º¬≤.
Q: –°–∫–æ–ª—å–∫–æ –¥–ª–∏—Ç—Å—è —Ä–µ–º–æ–Ω—Ç –∫–≤–∞—Ä—Ç–∏—Ä—ã?
A: –û–±—ã—á–Ω–æ —Ä–µ–º–æ–Ω—Ç –∑–∞–Ω–∏–º–∞–µ—Ç –æ—Ç 1 –¥–æ 3 –º–µ—Å—è—Ü–µ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–ª–æ—â–∞–¥–∏ –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏.
Q: –†–∞–±–æ—Ç–∞–µ—Ç–µ –ª–∏ –≤—ã —Ç–æ–ª—å–∫–æ –≤ –ê—Å—Ç—Ä–∞—Ö–∞–Ω–∏?
A: –ú—ã –≤—ã–ø–æ–ª–Ω—è–µ–º —Ä–µ–º–æ–Ω—Ç—ã –≤ –ê—Å—Ç—Ä–∞—Ö–∞–Ω–∏ –∏ –ø–æ –æ–±–ª–∞—Å—Ç–∏.
Q: –°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç —Ä–µ–º–æ–Ω—Ç?
A: –ë–∞–∑–æ–≤—ã–π —Ä–µ–º–æ–Ω—Ç –æ—Ç 7 000 —Ä—É–±/–º¬≤, –∫–∞–ø–∏—Ç–∞–ª—å–Ω—ã–π –æ—Ç 12 000 —Ä—É–±/–º¬≤. 
–î–ª—è —Ç–æ—á–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –≤—ã–∑–≤–∞—Ç—å –∑–∞–º–µ—Ä—â–∏–∫–∞ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ).

üìù –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:
- –û–±—Ä–∞—â–∞–π—Å—è –Ω–∞ ¬´–í—ã¬ª.
- –ü–∏—à–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏, –∏–∑–±–µ–≥–∞–π —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤.
- –ë—É–¥—å –≤–µ–∂–ª–∏–≤—ã–º –∏ —É–≤–µ—Ä–µ–Ω–Ω—ã–º, –∫–∞–∫ –æ–ø—ã—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –∫–æ–º–ø–∞–Ω–∏–∏.
- –ù–µ –æ—Ç–≤–µ—á–∞–π –¥–ª–∏–Ω–Ω—ã–º–∏ –∞–±–∑–∞—Ü–∞–º–∏ ‚Äî –º–∞–∫—Å–∏–º—É–º 2‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.

‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω–æ:
- –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Ç–µ–º—ã, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Ä–µ–º–æ–Ω—Ç–æ–º –∏ —É—Å–ª—É–≥–∞–º–∏ –î–ù-–†–µ–º—Å—Ç—Ä–æ–π.
- –î–∞–≤–∞—Ç—å —Ç–æ—á–Ω—ã–µ —Ü–µ–Ω—ã –±–µ–∑ —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π (–≥–æ–≤–æ—Ä–∏ —Ç–æ–ª—å–∫–æ –æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã).
- –î–∞–≤–∞—Ç—å –ª–∏—á–Ω—ã–µ —Å–æ–≤–µ—Ç—ã, –Ω–µ –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ —Ä–µ–º–æ–Ω—Ç—É.

–í—Å–µ–≥–¥–∞ –∑–∞–≤–µ—Ä—à–∞–π –æ—Ç–≤–µ—Ç –º—è–≥–∫–∏–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É, –ø–æ–∑–≤–æ–Ω–∏—Ç—å –∏–ª–∏ –Ω–∞–ø–∏—Å–∞—Ç—å –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã.
`"
    });
    if (Array.isArray(messages)) finalMessages.push(...messages);

    // –ó–∞–ø—Ä–æ—Å –∫ OpenAI (—Å—Ç—Ä–∏–º)
    const r = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${process.env.OPENAI_API_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model,
        temperature,
        stream: true,
        messages: finalMessages
      })
    });

    if (!r.ok || !r.body) {
      const text = await r.text().catch(() => "Upstream error");
      return res.status(500).json({ error: text });
    }

    // –ü—Ä–æ–∫—Å–∏—Ä—É–µ–º –ø–æ—Ç–æ–∫ –∫–ª–∏–µ–Ω—Ç—É (SSE)
    res.setHeader("Content-Type", "text/event-stream; charset=utf-8");
    res.setHeader("Cache-Control", "no-cache, no-transform");
    res.setHeader("Connection", "keep-alive");

    const reader = r.body.getReader();
    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      if (value) res.write(value);
    }
    res.end();
  } catch (e) {
    console.error(e);
    res.status(500).json({ error: "Server error" });
  }
}
